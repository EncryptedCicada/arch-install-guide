#Install ArchLinux with btrfs and subvolumes without encryption
#Created by EncryptedCicada on 26 Jun 2021
#Info adapted from Arch Wiki and various other sources

DRIVE=/dev/nvme0n1

#Wipe disk
sgdisk --zap-all $DRIVE

#Create partitions
sgdisk --clear --new=1:0:+550MiB --typecode=1:ef00 --change-name=1:EFI --new=2:0:+16GiB --typecode=2:8200 --change-name=2:swap --new=3:0:0 --typecode=3:8300 --change-name=3:system $DRIVE

#View and verify the partion table
lsblk -o +PARTLABEL

#Format EFI Partition
mkfs.fat -F32 -n EFI /dev/disk/by-partlabel/EFI

#Make and enable swap
mkswap -L swap /dev/disk/by-partlabel/swap
swapon -L swap

#Format system partition as btrfs and create subvolumes
mkfs.btrfs --force --label system /dev/disk/by-partlabel/system
o=defaults,x-mount.mkdir
o_btrfs=$o,compress=lzo,ssd,noatime
mount -t btrfs LABEL=system /mnt
btrfs subvolume create /mnt/root
btrfs subvolume create /mnt/home
btrfs subvolume create /mnt/snapshots
umount -R /mnt
mount -t btrfs -o subvol=root,$o_btrfs LABEL=system /mnt
mount -t btrfs -o subvol=root,$o_btrfs LABEL=system /mnt
mount -t btrfs -o subvol=home,$o_btrfs LABEL=system /mnt/home
mount -t btrfs -o subvol=snapshots,$o_btrfs LABEL=system /mnt/.snapshots

#Make and mount boot partition
mkdir /mnt/boot
mount LABEL=EFI /mnt/boot

#Install base system
pacstrap /mnt base linux linux-firmware btrfs-progs

#Generate fstab
genfstab -L -p /mnt >> /mnt/etc/fstab
#Check fstab
cat /mnt/etc/fstab

#Chroot into installed system
arch-chroot /mnt /bin/bash


#THE FOLLOWING COMMANDS ARE RUN IN CHROOT!!!


ln -s /usr/share/zoneinfo/Asia/Kolkata /etc/localtime

hwclock --systohc

#Install some necessary packages, for example:
pacman -S nano git

#Edit /etc/locale.gen and uncomment en_IN UTF-8 and other needed locales. Generate the locales by running:
locale-gen

#Create the locale.conf (/etc/locale.conf) file, and set the LANG variable accordingly:
LANG=en_IN

#Set hostname and setup /etc/hosts file
echo MechyMamba > /etc/hostname
nano /etc/hosts
******START OF /etc/hosts FILE******
127.0.0.1       localhost
::1             localhost
127.0.1.1       MechyMamba.localhost  MechyMamba
******END OF FILE******

#Setup root passwd (Process to disable root password at near the EOF)
passwd

#Add user
useradd -m -G wheel mamba
passwd mamba

#Install sudo
pacman -S sudo

#Edit the sudoers file to give access to added user for elevated previlidges (uncomment # %wheel ALL=(ALL) ALL)
EDITOR=nano visudo

******PART OF FILE TO BE EDITED******
%wheel ALL=(ALL) ALL
******Save the file******

#Install other necessary packages
pacman -S pipewire pipewire-alsa pipewire-pulse cups ttf-liberation noto-fonts noto-fonts-cjk noto-fonts-emoji noto-fonts-extra bash-completion

#Enable CUPS socket detection
systemctl enable cups.socket

#Create default directories
cd home/mamba/
mkdir Downloads Documents Videos Pictures

#Install WM of choice
pacman -S sway dmenu

#OPTIONAL(If you're installing a full-blown desktop environment like Gnome, sometimes GDM doesn't start automatically. For amdgpu users this is the fix)
nano /etc/mkinitcpio.conf
#Edit the line that says MODULES=() and add the following in the beginning just after the bracket:
amdgpu
#The edited line shound look somethng like this:
MODULES=(amdgpu ...)

#To exit chroot, type: (optionally do ctrl+d)
exit

#Unmount all partitions with
umount -R /mnt

#To reboot into the newly installed system type:
reboot
#Remember to remove the installation medium and then login into the new system with the root account.

#For people who wish to disable password for root account just follow this step:
sudo usermod -p '!' root
#this sets root to have a disabled password
